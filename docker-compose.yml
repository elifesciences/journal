version: '3'

services:
    api_dummy:
        image: elifesciences/api-dummy:${DEPENDENCIES_API_DUMMY}
        ports:
        - '${JOURNAL_API_DUMMY_PORT}:8080'
    assets:
        build:
            context: .
            dockerfile: Dockerfile.assets
            args:
                composer_dev_arg: ${COMPOSER_DEV_ARG}
                node_version: ${NODE_VERSION}
                image_tag: ${IMAGE_TAG}
        command: /bin/bash
        environment:
            - CRITICAL_CSS_BASE_URL=http://web:8080
        volumes:
          - shared_volume:/srv/journal/
    redis:
        image: redis:6.2-alpine
    app:
        build:
            context: .
            args:
                image_tag: ${IMAGE_TAG}
                php_version: ${PHP_VERSION}
        environment:
            - SYMFONY__API_URL=${API_URL}
            - SYMFONY__API_URL_PUBLIC=${API_URL_PUBLIC}
            - SYMFONY__API_KEY=${API_KEY}
        image: elifesciences/journal:${IMAGE_TAG}
        volumes:
            - shared_volume:/srv/journal/
        depends_on:
            - assets
            - redis
    web:
        build:
            context: .
            dockerfile: Dockerfile.web
            args:
                image_tag: ${IMAGE_TAG}
        image: elifesciences/journal_web:${IMAGE_TAG}
        ports:
            - '${JOURNAL_PORT}:80'
        depends_on:
            - app


volumes:
    shared_volume: