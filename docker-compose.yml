version: '3.4'

services:
    composer:
        build:
            context: .
            dockerfile: Dockerfile
            target: composer
            args:
                node_version: ${NODE_VERSION}
                composer_dev_arg: ${COMPOSER_DEV_ARG}
        command: /bin/bash
    assets:
        build:
            context: .
            dockerfile: Dockerfile
            target: assets
            args:
                composer_dev_arg: ${COMPOSER_DEV_ARG}
                node_version: ${NODE_VERSION}
        command: /bin/bash
    redis:
        image: redis:6.2-alpine
    app:
        build:
            context: .
            dockerfile: Dockerfile
            target: app
            args:
                node_version: ${NODE_VERSION}
                php_version: ${PHP_VERSION}
        environment:
            - SYMFONY__API_URL=${API_URL}
            - SYMFONY__API_URL_PUBLIC=${API_URL_PUBLIC}
            - SYMFONY__API_KEY=${API_KEY}
        volumes:
            - ./.docker/parameters.yml:/srv/journal/app/config/parameters.yml
        depends_on:
            - assets
            - redis
    web:
        build:
            context: .
            dockerfile: Dockerfile
            target: web
            args:
                node_version: ${NODE_VERSION}
                php_version: ${PHP_VERSION}
        ports:
            - '${JOURNAL_PORT}:80'
        depends_on:
            - app
    api_dummy:
        image: elifesciences/api-dummy:${DEPENDENCIES_API_DUMMY}
        ports:
        - '${JOURNAL_API_DUMMY_PORT}:8080'
    critical_css:
        build:
            context: .
            dockerfile: Dockerfile
            target: critical_css
            args:
                node_version: ${NODE_VERSION}
                php_version: ${PHP_VERSION}
        environment:
            - CRITICAL_CSS_BASE_URL=http://web:8080
        depends_on:
            - assets
            - web
            - api_dummy